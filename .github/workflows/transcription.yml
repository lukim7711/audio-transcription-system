name: Audio Transcription Workflow

on:
  repository_dispatch:
    types: [transcription_job]

jobs:
  trigger-kaggle:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Kaggle CLI
        run: pip install kaggle

      - name: Prepare and Push to Kaggle
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
          # Mengambil data dari payload webhook frontend
          JOB_ID: ${{ github.event.client_payload.job_id }}
          VIDEO_URL: ${{ github.event.client_payload.video_url }}
          MODEL_SIZE: ${{ github.event.client_payload.model_size }}
          LANGUAGE: ${{ github.event.client_payload.language }}
          WEBHOOK_URL: ${{ github.event.client_payload.webhook_url }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          mkdir -p transcription_build
          
          # GUNAKAN PYTHON UNTUK INJEKSI VARIABEL & BUAT METADATA
          # Ini lebih aman untuk menangani karakter spesial pada secret
          python3 -c '
          import os
          import json
          
          # 1. Baca script asli
          with open("kaggle/transcription_notebook.py", "r") as f:
              original_code = f.read()
              
          # 2. Ambil variabel dari GitHub Env
          env_vars = {
              "JOB_ID": os.environ.get("JOB_ID"),
              "VIDEO_URL": os.environ.get("VIDEO_URL"),
              "MODEL_SIZE": os.environ.get("MODEL_SIZE"),
              "LANGUAGE": os.environ.get("LANGUAGE"),
              "WEBHOOK_URL": os.environ.get("WEBHOOK_URL"),
              "WEBHOOK_SECRET": os.environ.get("WEBHOOK_SECRET"),
              "R2_ENDPOINT": os.environ.get("R2_ENDPOINT"),
              "R2_ACCESS_KEY": os.environ.get("R2_ACCESS_KEY"),
              "R2_SECRET_KEY": os.environ.get("R2_SECRET_KEY"),
              "R2_BUCKET": os.environ.get("R2_BUCKET"),
          }
          
          # 3. Buat blok kode injeksi (hardcode env vars ke dalam script)
          # Menggunakan repr() memastikan string dikutip dan di-escape dengan benar
          injection_code = "import os\n"
          for key, value in env_vars.items():
              if value:
                  injection_code += f"os.environ[\"{key}\"] = {repr(value)}\n"
          
          # Gabungkan: Injeksi di atas, kode asli di bawah
          final_code = injection_code + "\n" + original_code
          
          # Tulis script final ke folder build
          with open("transcription_build/notebook.py", "w") as f:
              f.write(final_code)
              
          # 4. Generate Metadata Kernel
          username = os.environ.get("KAGGLE_USERNAME")
          job_id = env_vars["JOB_ID"] or "test-job"
          short_id = job_id[:8]
          slug = f"audio-transcription-{short_id}"
          title = f"Transcription Job {short_id}"
          
          print(f"⚙️ Generating metadata for: {username}/{slug}")
          
          metadata = {
              "id": f"{username}/{slug}",
              "title": title,
              "code_file": "notebook.py",
              "language": "python",
              "kernel_type": "script",
              "is_private": True,
              "enable_gpu": True,
              "enable_internet": True,
              "dataset_sources": [],
              "kernel_sources": [],
              "kernel_data_sources": []
          }
          
          with open("transcription_build/kernel-metadata.json", "w") as f:
              json.dump(metadata, f, indent=2)
          '
          
          # 3. Push ke Kaggle
          cd transcription_build
          kaggle kernels push
          
          echo "✅ Push command executed successfully!"