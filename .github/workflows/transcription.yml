name: Audio Transcription Workflow

on:
  repository_dispatch:
    types: [transcription_job]

jobs:
  trigger-kaggle:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Kaggle CLI
        run: pip install kaggle

      - name: Prepare and Push to Kaggle
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
          # Data Dinamis (Aman untuk di-inject karena bukan rahasia server)
          JOB_ID: ${{ github.event.client_payload.job_id }}
          VIDEO_URL: ${{ github.event.client_payload.video_url }}
          MODEL_SIZE: ${{ github.event.client_payload.model_size }}
          LANGUAGE: ${{ github.event.client_payload.language }}
          WEBHOOK_URL: ${{ github.event.client_payload.webhook_url }}
          # R2 Public URL & Bucket (Bukan rahasia server)
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
        run: |
          mkdir -p transcription_build
          
          python3 -c '
          import os
          import json
          
          # 1. Baca script asli (Code Logic)
          with open("kaggle/transcription_notebook.py", "r") as f:
              original_code = f.read()
              
          # 2. INJEKSI VARIABLE DINAMIS (Job ID, Video URL)
          # Kita TIDAK meng-inject Secrets (Key/Pass) di sini.
          # Secrets akan diambil script via UserSecretsClient dari settingan Kaggle yang sudah dicentang.
          env_vars = {
              "JOB_ID": os.environ.get("JOB_ID"),
              "VIDEO_URL": os.environ.get("VIDEO_URL"),
              "MODEL_SIZE": os.environ.get("MODEL_SIZE"),
              "LANGUAGE": os.environ.get("LANGUAGE"),
              "WEBHOOK_URL": os.environ.get("WEBHOOK_URL"),
              "R2_BUCKET": os.environ.get("R2_BUCKET"),
              "R2_PUBLIC_URL": os.environ.get("R2_PUBLIC_URL"),
          }
          
          injection_code = "import os\n"
          for key, value in env_vars.items():
              if value:
                  injection_code += f"os.environ[\"{key}\"] = {repr(value)}\n"
          
          # Gabungkan
          final_code = injection_code + "\n" + original_code
          
          with open("transcription_build/notebook.py", "w") as f:
              f.write(final_code)
              
          # 3. METADATA (PERSISTENT WORKER)
          username = os.environ.get("KAGGLE_USERNAME")
          
          # FIXED SLUG: Ini KUNCI-nya. 
          # Kita menimpa kernel yang SAMA berulang kali agar settingan Secrets tidak hilang.
          slug = "audio-transcription-worker"
          title = "Audio Transcription Worker"
          
          print(f"⚙️ Target Kernel: {username}/{slug}")
          
          metadata = {
              "id": f"{username}/{slug}",
              "title": title,
              "code_file": "notebook.py",
              "language": "python",
              "kernel_type": "script",
              "is_private": True,
              "enable_gpu": True,
              "enable_internet": True,
              "dataset_sources": [],
              "kernel_sources": [],
              "kernel_data_sources": []
          }
          
          with open("transcription_build/kernel-metadata.json", "w") as f:
              json.dump(metadata, f, indent=2)
          '
          
          # 4. Push (Update Kernel yang sudah ada)
          cd transcription_build
          kaggle kernels push
          
          echo "✅ Worker updated and triggered successfully!"